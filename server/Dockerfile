FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .

ARG AWS_BUCKET_ACCESS_KEY="AKIA43LPYJBUVZLBR6XQ"
ENV AWS_BUCKET_ACCESS_KEY=${AWS_BUCKET_ACCESS_KEY}

ARG AWS_BUCKET_NAME="react-nest-app"
ENV AWS_BUCKET_NAME=${AWS_BUCKET_NAME}

ARG AWS_BUCKET_SECRET_ACCESS_KEY="3tKJ0DRPzoMI+ddH72XwKh/SjWftqbjMqsnhQbCF"
ENV AWS_BUCKET_SECRET_ACCESS_KEY=${AWS_BUCKET_SECRET_ACCESS_KEY}

ARG AWS_S3_REGION="ap-northeast-2"
ENV AWS_S3_REGION=${AWS_S3_REGION}

ARG DB_HOST="localhost"
ENV DB_HOST=${DB_HOST}

ARG DB_NAME="react-nest-app"
ENV DB_NAME=${DB_NAME}

ARG DB_PASSWORD="tntls1!@"
ENV DB_PASSWORD=${DB_PASSWORD}

ARG DB_PORT="5432"
ENV DB_PORT=${DB_PORT}

ARG DB_USERNAME="sup_kimba"
ENV DB_USERNAME=${DB_USERNAME}

ARG GOOGLE_CLIENT_ID="94783435890-slu12as6an5hjfq0hn5mtth6evnod9vm.apps.googleusercontent.com"
ENV GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}

ARG GOOGLE_OAUTH_REDIRECT_URL="http://localhost:4000/api/auth/google/callback"
ENV GOOGLE_OAUTH_REDIRECT_URL=${GOOGLE_OAUTH_REDIRECT_URL}

ARG GOOGLE_SECRET="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"
ENV GOOGLE_SECRET=${GOOGLE_SECRET}

ARG HASH_ROUNDS="10"
ENV HASH_ROUNDS=${HASH_ROUNDS}

ARG HOST="localhost:4000"
ENV HOST=${HOST}

ARG JWT_SECRET="react-nest-app"
ENV JWT_SECRET=${JWT_SECRET}

RUN npm run build

FROM node:18-alpine
WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY package*.json ./
RUN npm install
RUN rm package*.json
EXPOSE 4000
CMD ["node", "dist/main.js"]
